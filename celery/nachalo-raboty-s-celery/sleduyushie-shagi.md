# Следующие шаги

Руководство «[Первые шаги с Celery](pervye-shagi-s-celery.md)» намеренно сведено к минимуму. В этом руководстве я более подробно покажу, что предлагает Celery, в том числе как добавить поддержку Celery для вашего приложения и библиотеки.

В этом документе не описаны все функции и рекомендации Celery, поэтому рекомендуется также прочитать [Руководство пользователя](../rukovodstvo-polzovatelya-celery/).



_Здесь должно быть оглавление..._

## Использование Celery в вашем приложении

### Наш проект

Макет проекта:

```bash
proj/__init__.py
    /celery.py
    /tasks.py
```

#### proj/celery.py

```python
from celery import Celery

app = Celery('proj',
             broker='amqp://',
             backend='rpc://',
             include=['proj.tasks'])

# Дополнительная конфигурация, см. руководство пользователя приложения.
app.conf.update(
    result_expires=3600,
)

if __name__ == '__main__':
    app.start()
```

В этом модуле вы создали наш экземпляр Celery (иногда называемый приложением **app**). Чтобы использовать Celery в своем проекте, вы просто импортируете этот экземпляр.

* Аргумент **broker** указывает URL-адрес используемого брокера. Дополнительную информацию см. в разделе [Выбор брокера](pervye-shagi-s-celery.md#vybor-brokera).
* Аргумент **backend** указывает используемую серверную часть результата. Он используется для отслеживания состояния задач и результатов. Хотя результаты по умолчанию отключены, я использую здесь серверную часть результатов RPC, потому что позже я продемонстрирую, как работает получение результатов. Возможно, вы захотите использовать другой бэкенд для своего приложения. Все они имеют разные сильные и слабые стороны. Если вам не нужны результаты, лучше их отключить. Результаты также можно отключить для отдельных задач, установив параметр `@task(ignore_result=True)`. Дополнительные сведения см. в разделе [Сохранение результатов](pervye-shagi-s-celery.md#sokhranenie-rezultatov).
* Аргумент **include** — это список модулей, которые нужно импортировать при запуске воркера. Вам нужно добавить сюда наш модуль задач, чтобы воркер смог найти наши задачи.

#### proj/tasks.py

```python
from .celery import app

@app.task
def add(x, y):
    return x + y

@app.task
def mul(x, y):
    return x * y

@app.task
def xsum(numbers):
    return sum(numbers)
```

### Запуск воркера

Программу **celery** можно использовать для запуска воркера (вам нужно запустить воркера в каталоге выше **proj**):

```bash
$ celery -A proj worker -l INFO
```

При запуске воркера вы должны увидеть баннер и несколько сообщений:

```bash
--------------- celery@halcyon.local v4.0 (latentcall)
--- ***** -----
-- ******* ---- [Configuration]
- *** --- * --- . broker:      amqp://guest@localhost:5672//
- ** ---------- . app:         __main__:0x1012d8590
- ** ---------- . concurrency: 8 (processes)
- ** ---------- . events:      OFF (enable -E to monitor this worker)
- ** ----------
- *** --- * --- [Queues]
-- ******* ---- . celery:      exchange:celery(direct) binding:celery
--- ***** -----

[2012-06-08 16:23:51,078: WARNING/MainProcess] celery@halcyon.local has started.
```

* **broker** — это URL-адрес, который вы указали в аргументе _broker_ в нашем модуле celery. Вы также можете указать другого посредника в командной строке, используя параметр [`-b`](https://docs.celeryq.dev/en/stable/reference/cli.html#cmdoption-celery-b).
* **concurrency** — это количество рабочих процессов **prefork**, используемых для одновременной обработки ваших задач. Когда все они заняты выполнением работы, новым задачам придется ждать завершения одной из задач, прежде чем ее можно будет обработать. Число concurrency по умолчанию — это количество ЦП на этой машине (включая ядра). Вы можете указать собственный номер, используя параметр [`celery worker -c`](https://docs.celeryq.dev/en/stable/reference/cli.html#cmdoption-celery-worker-c). Рекомендуемого значения нет, так как оптимальное число зависит от ряда факторов, но если ваши задачи в основном связаны с вводом-выводом, вы можете попытаться увеличить его. Эксперименты показали, что увеличение числа ЦП более чем в два раза редко бывает эффективным и, скорее всего, приведет к снижению производительности. Включая пул **prefork** по умолчанию, Celery также поддерживает использование Eventlet, Gevent и выполнение в одном потоке (см. [Concurrency](https://docs.celeryq.dev/en/stable/userguide/concurrency/index.html#concurrency)).
* **events** — это параметр, который заставляет Celery отправлять сообщения мониторинга (события) для действий, происходящих в рабочем потоке. Они могут использоваться программами мониторинга, такими как celery events и Flower — монитор Celery в реальном времени, о котором вы можете прочитать в руководстве по мониторингу и управлению ([Monitoring and Management guide](https://docs.celeryq.dev/en/stable/userguide/monitoring.html#guide-monitoring)).
* **Queues** — это список очередей, из которых рабочий процесс будет потреблять задачи. Рабочим процессам можно указать потреблять из нескольких очередей одновременно, и это используется для маршрутизации сообщений к конкретным рабочим процессам в качестве средства обеспечения качества обслуживания, разделения задач и определения приоритетов, все это описано в Руководстве по маршрутизации ([Routing Guide](https://docs.celeryq.dev/en/stable/userguide/routing.html#guide-routing)).

Вы можете получить полный список аргументов командной строки, передав флаг **--help**:

```bash
$ celery worker --help
```

Эти параметры более подробно описаны в Руководстве для рабочих ([Workers Guide](https://docs.celeryq.dev/en/stable/userguide/workers.html#guide-workers)).

### Остановка воркера

Чтобы остановить воркер, просто нажмите **Control-c**. Список сигналов, поддерживаемых воркером, подробно описан в Руководстве воркеров ([Workers Guide](https://docs.celeryq.dev/en/stable/userguide/workers.html#guide-workers)).

{% hint style="danger" %}
**Начиная отсюда Gitbook все просрал**
{% endhint %}
